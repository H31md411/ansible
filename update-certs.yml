---
- name: Check and renew SSL certificate if needed
  hosts: webserver
  become: yes

  vars:
    domain: "homelab.lan"
    cert_renewed: false

  tasks:
    - name: Get the hostname of the server
      setup:
        filter: ansible_hostname
      register: hostname

    - name: Set the hostname as domain_name
      set_fact:
        domain_name: "{{ hostname.ansible_facts.ansible_hostname }}.{{ domain }}"

    - name: Check the SSL certificate validity
      command: "date -d \"$(openssl x509 -enddate -noout -in /etc/ssl/certs/{{ domain_name }}.crt | cut -d'=' -f2-)\" +%s"
      register: cert_end_date

    - name: Calculate the Unix timestamp for 2 weeks in the future
      set_fact:
        two_weeks_future: "{{ ansible_date_time.epoch | int + (2 * 7 * 24 * 3600) }}"

    - name: Renew SSL certificate if it's expiring soon
      command: "openssl req -x509 -newkey rsa:4096 -keyout /etc/ssl/private/{{ domain_name }}.key -out /etc/ssl/certs/{{ domain_name }}.crt -days 365 -nodes -subj '/CN={{ domain_name }}'"
      when: cert_end_date.stdout | int < two_weeks_future
      register: cert_renew_result
      changed_when: cert_renew_result.stdout.find('not creating new certificate') == -1

    - name: Configure Nginx to use the updated SSL certificate
      blockinfile:
        path: "/etc/nginx/sites-available/default"  # Path to nginx-Config
        block: |
          server {
              listen 443 ssl;
              server_name {{ domain_name }};

              ssl_certificate /etc/ssl/certs/{{ domain_name }}.crt;
              ssl_certificate_key /etc/ssl/private/{{ domain_name }}.key;

              # ... Weitere SSL- und Serverkonfigurationen ...
          }
      when: cert_renew_result.changed

    - name: Reload Nginx to apply the SSL configuration
      systemd:
        name: "nginx"  # service name for nginx-service
        state: restarted
      when: cert_renew_result.changed
