---
- name: Generate and install self-signed SSL certificate for Nginx
  hosts: your_nginx_server
  become: yes

  tasks:
    - name: Get the hostname of the server
      setup:
        filter: ansible_hostname
      register: hostname

    - name: Set the hostname as domain_name
      set_fact:
        domain_name: "{{ hostname.ansible_facts.ansible_hostname }}"

    - name: Generate a self-signed SSL certificate
      command: "openssl req -x509 -newkey rsa:4096 -keyout /etc/ssl/private/{{ domain_name }}.key -out /etc/ssl/certs/{{ domain_name }}.crt -days 365 -nodes -subj '/CN={{ domain_name }}'"

    - name: Configure Nginx to use the self-signed SSL certificate
      blockinfile:
        path: "/etc/nginx/sites-available/default"  # Ändern Sie den Pfad je nach Nginx-Konfiguration
        block: |
          server {
              listen 443 ssl;
              server_name {{ domain_name }};

              ssl_certificate /etc/ssl/certs/{{ domain_name }}.crt;
              ssl_certificate_key /etc/ssl/private/{{ domain_name }}.key;

              # ... Weitere SSL- und Serverkonfigurationen ...
          }

    - name: Reload Nginx to apply the SSL configuration
      systemd:
        name: "nginx"  # Ändern Sie den Dienstnamen je nach Nginx-Konfiguration
        state: restarted
